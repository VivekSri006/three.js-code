var sparkData64 = 
"png.png";
var data = [

  {
    "type": "FeatureCollection",
    "features": [
      {
        "type": "Feature",
        "properties": {},
        "geometry": {
          "type": "LineString",
          "coordinates": [
            [
              77.01656341552734,
              28.45797659206641
            ],
            [
              77.01845169067383,
              28.461900413017254
            ],
            [
              77.02068328857422,
              28.466955890640936
            ],
            [
              77.02317237854004,
              28.462353152215343
            ],
            [
              77.02634811401367,
              28.45941031276284
            ],
            [
              77.02334403991699,
              28.45707107423914
            ],
            [
              77.01338768005371,
              28.445600510450063
            ],
            [
              77.00600624084471,
              28.438355302793127
            ]
          ]
        }
      },
      {
        "type": "Feature",
        "properties": {},
        "geometry": {
          "type": "LineString",
          "coordinates": [
            [
              77.01501846313477,
              28.45586370507054
            ],
            [
              77.01390266418456,
              28.45382623833138
            ],
            [
              77.00961112976074,
              28.4531470740262
            ],
            [
              77.00325965881348,
              28.450807696915962
            ],
            [
              76.99742317199707,
              28.448392801740574
            ],
            [
              77.0002555847168,
              28.44303455615879
            ],
            [
              77.01424598693846,
              28.433147503293302
            ]
          ]
        }
      },
      {
        "type": "Feature",
        "properties": {},
        "geometry": {
          "type": "LineString",
          "coordinates": [
            [
              77.01973915100098,
              28.472765618471456
            ],
            [
              77.03201293945312,
              28.462277695817004
            ],
            [
              77.03364372253417,
              28.4634095361356
            ],
            [
              77.04214096069336,
              28.473897346454972
            ]
          ]
        }
      },
      {
        "type": "Feature",
        "properties": {},
        "geometry": {
          "type": "LineString",
          "coordinates": [
            [
              77.02686309814453,
              28.4589575609595
            ],
            [
              77.02875137329102,
              28.45669377285521
            ],
            [
              77.03347206115723,
              28.446506126513928
            ],
            [
              77.03553199768066,
              28.43480798893894
            ]
          ]
        }
      },
      {
        "type": "Feature",
        "properties": {},
        "geometry": {
          "type": "LineString",
          "coordinates": [
            [
              77.02857971191406,
              28.458353888871844
            ],
            [
              77.03192710876465,
              28.459787604450966
            ],
            [
              77.03235626220703,
              28.458353888871844
            ],
            [
              77.03433036804199,
              28.459334854263627
            ],
            [
              77.04677581787108,
              28.447336267760274
            ]
          ]
        }
      },
      {
        "type": "Feature",
        "properties": {},
        "geometry": {
          "type": "LineString",
          "coordinates": [
            [
              77.03604698181152,
              28.464164089614023
            ],
            [
              77.04720497131348,
              28.47020032349105
            ],
            [
              77.05484390258789,
              28.473595553511476
            ],
            [
              77.05690383911133,
              28.468691297348148
            ],
            [
              77.07158088684082,
              28.458127510950163
            ],
            [
              77.06385612487793,
              28.44990211768783
            ]
          ]
        }
      },
      {
        "type": "Feature",
        "properties": {},
        "geometry": {
          "type": "LineString",
          "coordinates": [
            [
              77.05793380737305,
              28.44394019419311
            ],
            [
              77.04952239990234,
              28.434883464940082
            ],
            [
              77.05827713012695,
              28.42793944748537
            ],
            [
              77.0668601989746,
              28.437147719939624
            ],
            [
              77.07612991333008,
              28.44590238333296
            ]
          ]
        }
      },
      {
        "type": "Feature",
        "properties": {},
        "geometry": {
          "type": "LineString",
          "coordinates": [
            [
              77.01596260070801,
              28.432392728477073
            ],
            [
              77.02162742614746,
              28.428467812654425
            ],
            [
              77.0221424102783,
              28.427486560955444
            ],
            [
              77.02523231506348,
              28.42597692519382
            ],
            [
              77.04523086547852,
              28.430581246954063
            ],
            [
              77.04806327819824,
              28.433373934688372
            ]
          ]
        }
      },
      {
        "type": "Feature",
        "properties": {},
        "geometry": {
          "type": "LineString",
          "coordinates": [
            [
              76.98866844177246,
              28.40695367011374
            ],
            [
              76.9896125793457,
              28.408992039467297
            ],
            [
              76.98952674865723,
              28.411936281507877
            ],
            [
              76.9910717010498,
              28.41593729976054
            ],
            [
              76.99175834655762,
              28.4163902356983
            ],
            [
              76.99424743652344,
              28.42137240314652
            ],
            [
              76.99544906616211,
              28.42635433615272
            ],
            [
              77.00549125671387,
              28.437902460838288
            ]
          ]
        }
      },
      {
        "type": "Feature",
        "properties": {},
        "geometry": {
          "type": "LineString",
          "coordinates": [
            [
              76.96094512939453,
              28.452090587546824
            ],
            [
              76.96094512939453,
              28.431562469961413
            ],
            [
              76.9643783569336,
              28.416767680833228
            ],
            [
              76.9698715209961,
              28.41827744791909
            ],
            [
              76.98497772216795,
              28.40921852252982
            ]
          ]
        }
      },
      {
        "type": "Feature",
        "properties": {},
        "geometry": {
          "type": "LineString",
          "coordinates": [
            [
              77.0742416381836,
              28.459033019728043
            ],
            [
              77.07080841064452,
              28.478952250088554
            ],
            [
              77.09381103515624,
              28.47925402772786
            ],
            [
              77.0962142944336,
              28.464164089614023
            ],
            [
              77.09964752197266,
              28.449977582919693
            ],
            [
              77.08934783935547,
              28.451486876247632
            ],
            [
              77.07939147949219,
              28.447562668787487
            ]
          ]
        }
      },
      {
        "type": "Feature",
        "properties": {},
        "geometry": {
          "type": "LineString",
          "coordinates": [
            [
              77.04952239990234,
              28.48015935547218
            ],
            [
              77.0745849609375,
              28.511539251774604
            ],
            [
              77.08488464355469,
              28.507013881018153
            ],
            [
              77.091064453125,
              28.510332505222408
            ],
            [
              77.08179473876953,
              28.51757277743349
            ]
          ]
        }
      },
      {
        "type": "Feature",
        "properties": {},
        "geometry": {
          "type": "LineString",
          "coordinates": [
            [
              76.97124481201172,
              28.467484060916792
            ],
            [
              76.9980239868164,
              28.49373834028483
            ],
            [
              77.00489044189453,
              28.488005204159457
            ],
            [
              76.9767379760742,
              28.467484060916792
            ]
          ]
        }
      },
      {
        "type": "Feature",
        "properties": {},
        "geometry": {
          "type": "LineString",
          "coordinates": [
            [
              77.01141357421875,
              28.488608706834743
            ],
            [
              77.01484680175781,
              28.48136644705929
            ],
            [
              77.0199966430664,
              28.484082352684982
            ],
            [
              77.03510284423828,
              28.47804691199713
            ],
            [
              77.04402923583984,
              28.48136644705929
            ]
          ]
        }
      },
      {
        "type": "Feature",
        "properties": {},
        "geometry": {
          "type": "LineString",
          "coordinates": [
            [
              77.0193099975586,
              28.489212206060223
            ],
            [
              77.0199966430664,
              28.494945276635455
            ],
            [
              77.02857971191406,
              28.502488316130417
            ],
            [
              77.02617645263672,
              28.50912574486426
            ],
            [
              77.01278686523438,
              28.49947116503107
            ],
            [
              77.01004028320312,
              28.493134866934206
            ]
          ]
        }
      },
      {
        "type": "Feature",
        "properties": {},
        "geometry": {
          "type": "LineString",
          "coordinates": [
            [
              77.0306396484375,
              28.503393444637513
            ],
            [
              77.0302963256836,
              28.510332505222408
            ],
            [
              77.03441619873047,
              28.513651025019303
            ],
            [
              77.03956604003905,
              28.517874444655206
            ],
            [
              77.04711914062499,
              28.517874444655206
            ],
            [
              77.04231262207031,
              28.510935880224274
            ],
            [
              77.05810546875,
              28.503393444637513
            ],
            [
              77.07321166992188,
              28.516064428379895
            ],
            [
              77.05432891845703,
              28.532051830489543
            ]
          ]
        }
      },
      {
        "type": "Feature",
        "properties": {},
        "geometry": {
          "type": "LineString",
          "coordinates": [
            [
              76.99150085449219,
              28.40499075885129
            ],
            [
              77.01107025146484,
              28.400158822340533
            ],
            [
              77.04368591308594,
              28.401064827220896
            ],
            [
              77.04093933105469,
              28.41223825042304
            ],
            [
              77.02995300292969,
              28.408916545005503
            ],
            [
              77.02892303466797,
              28.41646572483292
            ],
            [
              77.02411651611327,
              28.421296917510052
            ]
          ]
        }
      },
      {
        "type": "Feature",
        "properties": {},
        "geometry": {
          "type": "LineString",
          "coordinates": [
            [
              77.05913543701172,
              28.407406644470846
            ],
            [
              77.0526123046875,
              28.422202741595626
            ],
            [
              77.05707550048828,
              28.425524030266843
            ],
            [
              77.06565856933594,
              28.420391085674304
            ],
            [
              77.0742416381836,
              28.41133234109476
            ],
            [
              77.09175109863281,
              28.416767680833228
            ],
            [
              77.0907211303711,
              28.430958641495092
            ]
          ]
        }
      },
      {
        "type": "Feature",
        "properties": {},
        "geometry": {
          "type": "LineString",
          "coordinates": [
            [
              77.05175399780273,
              28.389588193072406
            ],
            [
              77.06565856933594,
              28.393967581676023
            ],
            [
              77.07338333129883,
              28.396836738172365
            ],
            [
              77.07406997680663,
              28.400611825749028
            ],
            [
              77.07904815673828,
              28.401819825370357
            ],
            [
              77.07509994506836,
              28.40967148720211
            ]
          ]
        }
      },
      {
        "type": "Feature",
        "properties": {},
        "geometry": {
          "type": "LineString",
          "coordinates": [
            [
              77.08282470703125,
              28.490419194161678
            ],
            [
              77.09518432617188,
              28.507918970700576
            ],
            [
              77.09243774414062,
              28.512745984520496
            ],
            [
              77.10548400878906,
              28.53265508120663
            ],
            [
              77.11784362792969,
              28.538084182259816
            ],
            [
              77.1185302734375,
              28.544116188665107
            ],
            [
              77.135009765625,
              28.56281321321839
            ]
          ]
        }
      },
      {
        "type": "Feature",
        "properties": {},
        "geometry": {
          "type": "LineString",
          "coordinates": [
            [
              77.11509704589844,
              28.481969987679054
            ],
            [
              77.12265014648438,
              28.480762902990307
            ],
            [
              77.17414855957031,
              28.504298565379987
            ],
            [
              77.1796417236328,
              28.509729126769052
            ],
            [
              77.19062805175781,
              28.51877944114221
            ],
            [
              77.18994140625,
              28.529035525107243
            ]
          ]
        }
      },
    ]
  }

]
console.log(data)
for(let a=0;a<data.length;a++){
  
}
var routes=[]
for(var j=0 ; j<data[0].features.length;j++){
  let dataaa=[]
  let daa=[]
// for( var k=0;k<data[0].features[j].geometry.coordinates.length;k++){
  for(var i=0;i<data[0].features[j].geometry.coordinates.length;i++){
    dataaa =[data[0].features[j].geometry.coordinates[i][0],data[0].features[j].geometry.coordinates[i][1]]
    daa.push(dataaa)
  }
// }
  console.log(daa)
  var labell =(data[0].features[j].geometry.type+j)
  routes.push({ id: labell, colors: ["#0000ff", "#FFFFFF"], size: 8, t: 6.0, geo : daa})
}
// console.log(routes)
var count = 0;
var center = { LngLat : [ 77.01656341552734,
  28.45797659206641], altidute: 0, rotation : new THREE.Vector3(Math.PI / 2, 0, 0), scale: 5.4184E-8 };    

center.transform = {
    
    translateX: mapboxgl.MercatorCoordinate.fromLngLat(center.LngLat, center.altitude).x,
    translateY: mapboxgl.MercatorCoordinate.fromLngLat(center.LngLat, center.altitude).y,
    translateZ: mapboxgl.MercatorCoordinate.fromLngLat(center.LngLat, center.altitude).z,
    rotateX: center.rotation.x,
    rotateY: center.rotation.y,
    rotateZ: center.rotation.z,
    scale: center.scale
    
};

mapboxgl.accessToken = "pk.eyJ1IjoicmFqYW4wMjciLCJhIjoiY2s2b25oYTg1MDJtazNsbXZ4OTFqcnN2cSJ9.MGaLTVPvgOjQazj7ZTX1nQ";

var map = window.map = new mapboxgl.Map({
    
    container: "map",
    style: "mapbox://styles/mapbox/dark-v9",
    zoom: 7,
    center: center.LngLat,
    pitch: 36
    // bearing: 158   
});

var THREE = window.THREE;

var threejsLayer = {
    
    id: "threejs",
    type: "custom",
    renderingMode: "3d",

    onAdd: function(map_, gl_) {

      console.log(routes)
        this.camera = new THREE.Camera();
        this.scene = new THREE.Scene();

        const NUM = 10240, radius = 6, kofStep = 10 / radius, w = document.body.clientWidth,h = document.body.clientHeight;
        
        var shaderPoint = THREE.ShaderLib.points;
        var uniforms = THREE.UniformsUtils.clone(shaderPoint.uniforms);
        
        uniforms.size.value = radius * 1.0;
        uniforms.scale.value = h * 0.5

        var spark = new Image();
        uniforms.map.value = new THREE.Texture(spark);
        spark.onload = () => {
        uniforms.map.value.needsUpdate = true;
        };
        spark.src = sparkData64;
        
        var shaderMaterial = new THREE.ShaderMaterial({

        uniforms: uniforms,

            defines: {

                USE_COLOR: "",
                USE_MAP: "",
                USE_SIZEATTENUATION: "" 

            },

            transparent: false,
            depthWrite: false,
            blending: THREE.AdditiveBlending,
            vertexShader: shaderPoint.vertexShader,
            fragmentShader: shaderPoint.fragmentShader 
        
        })
        // var shaderMaterial = new THREE.MeshLambertMaterial({color:0xffffff})
        
        for(var i = 0; i < routes.length; i++){
            
            pointsGeometry = new THREE.BufferGeometry();
            pointsGeometry.addAttribute("position", new THREE.BufferAttribute(new Float32Array(NUM  * 3), 3));
            pointsGeometry.addAttribute("color", new THREE.BufferAttribute(new Float32Array(NUM * 3), 3));
            
            var geometry = new THREE.BufferGeometry();

            var range =  getVerticesFromRoute(routes[i].geo)

            var poss = new THREE.BufferAttribute(new Float32Array(NUM * 3), 3);

            geometry.color = new THREE.Color(0xFFFF00);

            poss.setDynamic(true).copyVector3sArray(range);
            geometry.setDrawRange(0, range.length);
            geometry.addAttribute("position", poss);
            geometry.lPos = geometry.attributes.position;

            var line = geometry;

            // var material = new THREE.LineBasicMaterial({ color: color, blending: THREE.AdditiveBlending });

            var attrs = generatePoints(line, kofStep);

            pointsGeometry.attributes.position.setDynamic(true).copyArray(attrs.positions);
            pointsGeometry.attributes.color.setDynamic(true).copyArray(attrs.colors);
            
            pointsGeometry.attributes.color.array = setColors(pointsGeometry.attributes.color.array, routes[i].colors);

            pointsGeometry.attributes.color.needsUpdate = true;
            
            pointsGeometry.setDrawRange(0, attrs.positions.length / 3);
            pointsGeometry.computeBoundingSphere();

            points = new THREE.Points(pointsGeometry, shaderMaterial);
            
            points.name = routes[i].id;
            this.scene.add(points);
            // console.log(points)
            
        }
        
        
        this.map = map_;

        this.renderer = new THREE.WebGLRenderer({ canvas: map.getCanvas(), context: gl_ });
        this.renderer.autoClear = false;
    
    },
    
    render: function(gl_, matrix_) {

        var rotationX = new THREE.Matrix4().makeRotationAxis(new THREE.Vector3(1, 0, 0), center.rotation.x);
        var rotationY = new THREE.Matrix4().makeRotationAxis(new THREE.Vector3(0, 1, 0), center.rotation.y);
        var rotationZ = new THREE.Matrix4().makeRotationAxis(new THREE.Vector3(0, 0, 1), center.rotation.z);

        var m = new THREE.Matrix4().fromArray(matrix_);
        
        var l = new THREE.Matrix4().makeTranslation(center.transform.translateX, center.transform.translateY, center.transform.translateZ)
        .scale(new THREE.Vector3(center.scale, -center.scale, center.scale))
        .multiply(rotationX)
        .multiply(rotationY)
        .multiply(rotationZ);

        this.camera.projectionMatrix.elements = matrix_;
        this.camera.projectionMatrix = m.multiply(l);

        updateShift(this.scene);
        count++;
        
        this.renderer.state.reset();
        this.renderer.render(this.scene, this.camera);
        this.map.triggerRepaint();        
    }    
};
function update(){

    for(var i = 0; i < points.geometry.attributes.color.count * 3; i += 3){
    
        points.geometry.attributes.color.array[i + 1] += 0.01;
        points.geometry.attributes.color.array[i + 2] += 0.01;
        
        if(points.geometry.attributes.color.array[i + 1] >= 1.0) { points.geometry.attributes.color.array[i + 1] = points.geometry.attributes.color.array[i + 1] - Math.floor(points.geometry.attributes.color.array[i + 1]); }
        if(points.geometry.attributes.color.array[i + 2] >= 1.0) { points.geometry.attributes.color.array[i + 2] = points.geometry.attributes.color.array[i + 2] - Math.floor(points.geometry.attributes.color.array[i + 2]); }
         
    }
    
    points.geometry.attributes.color.needsUpdate = true;
    
    
}

function updateShift(scene_){
    
    for(var i = 0; i < routes.length; i++){

        var dir = routes[i].t > 0 ? "left" : "right";
        
        var obj = scene_.getObjectByName(routes[i].id);
            
            // console.log(routes[i].id)
            // console.log(obj.geometry)
            if(dir == "left"){
              // if(i<2)
              //   console.log(obj.geometry.attributes.color)
            //left shift
            var l0 = obj.geometry.attributes.color.array[obj.geometry.attributes.color.array.length - 3];
            var l1 = obj.geometry.attributes.color.array[obj.geometry.attributes.color.array.length - 2];
            var l2 = obj.geometry.attributes.color.array[obj.geometry.attributes.color.array.length - 1];
            // console.log(obj.geometry.attributes.color.array.length - 3)
            for(var j = obj.geometry.attributes.color.array.length - 3; j >= 0; j -= 3){
                
                obj.geometry.attributes.color.array[j] = obj.geometry.attributes.color.array[j - 3];
                obj.geometry.attributes.color.array[j + 1] = obj.geometry.attributes.color.array[j - 2];
                obj.geometry.attributes.color.array[j + 2] = obj.geometry.attributes.color.array[j - 1];
                
            }
            
            obj.geometry.attributes.color.array[0] = l0;
            obj.geometry.attributes.color.array[1] = l1;
            obj.geometry.attributes.color.array[2] = l2;
            // if(i<2)
            // console.log(obj.geometry.attributes.color)
            obj.geometry.attributes.color.needsUpdate = true;
            }
        //     else if(dir == "right"){

        //     //right shift
        //     var r0 = obj.geometry.attributes.color.array[0];
        //     var r1 = obj.geometry.attributes.color.array[1];
        //     var r2 = obj.geometry.attributes.color.array[2];

        //     for(var j = 3; j < obj.geometry.attributes.color.array.length; j += 3){

        //         obj.geometry.attributes.color.array[j - 3] = obj.geometry.attributes.color.array[j];
        //         obj.geometry.attributes.color.array[j - 2] = obj.geometry.attributes.color.array[j + 1];
        //         obj.geometry.attributes.color.array[j - 1] = obj.geometry.attributes.color.array[j + 2];

        //     }

        //     obj.geometry.attributes.color.array[obj.geometry.attributes.color.array.length - 3] = r0;
        //     obj.geometry.attributes.color.array[obj.geometry.attributes.color.array.length - 2] = r1;
        //     obj.geometry.attributes.color.array[obj.geometry.attributes.color.array.length - 1] = r2;
        //     obj.geometry.attributes.color.needsUpdate = true;

        //   }
            

   }
    
}

function setColors(array_, colors_){    
    var colorA = HexToFloat(colors_[0]);
    var colorB = HexToFloat(colors_[1]);    
    for(var i = 0; i < array_.length; i += 3){
        const  step = 302;
        var hash = (i) % step;        
        if(hash < step / 2){            
            array_[i] = lerpFloat(colorA.r, colorB.r, 1.0 / step / 2 * hash);
            array_[i + 1] = lerpFloat(colorA.g, colorB.g, 1.0 / step / 2 * hash);
            array_[i + 2] = lerpFloat(colorA.b, colorB.b, 1.0 / step / 2 * hash);            
        }else{            
            array_[i] = lerpFloat(colorB.r, colorA.r, 1.0 / step / 2 * (step - hash));
            array_[i + 1] = lerpFloat(colorB.g, colorA.g, 1.0 / step / 2 * (step - hash));
            array_[i + 2] = lerpFloat(colorB.b, colorA.g, 1.0 / step / 2 * (step - hash));            
        }        
    }    
    return array_;    
}

function HexToFloat(hex_) {
    
    var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex_);

    return result ? {
        
        r: parseInt(result[1], 16) / 255,
        g: parseInt(result[2], 16) / 255,
        b: parseInt(result[3], 16) / 255
        
    } : null;
    
}


function getVerticesFromRoute(geo_){
    
    var out = [];
    
    for(var i = 0; i < geo_.length; i++){ out.push(getPositionFromLongLat(center, geo_[i], 1.0)); }
    
    return out;
    
}

function getPositionFromLongLat(center_, LngLat_, z_){
    
    var centerCoords = mapboxgl.MercatorCoordinate.fromLngLat(center_.LngLat, 0);
    var objectCoords = mapboxgl.MercatorCoordinate.fromLngLat(LngLat_, 0);
    
    var dx = centerCoords.x - objectCoords.x;
    var dy = centerCoords.y - objectCoords.y;
    
    dx /= center_.scale;
    dy /= center_.scale;

    return new THREE.Vector3(-dx, z_, -dy);
}


map.on("style.load", function() { map.addLayer(threejsLayer, "water-label") });

function getPositions(points_, count_, alpha_) {
    
  var  positions = [];
  if (!points_) { return positions; }

  var l = count_,
      vec3s = new THREE.Vector3(),
      vec3e = new THREE.Vector3(),
      vec3n = new THREE.Vector3(),
      dist, size, i;
    
  while (l--) {
      
        vec3s.set(points_.getX(l), points_.getY(l), points_.getZ(l));
        vec3n.set(vec3s.x, vec3s.y, vec3s.z);

        if (l < 1) {

              positions.push(vec3n.x, vec3n.y, vec3n.z);
              break;

        }

        vec3e.set(points_.getX(l - 1), points_.getY(l - 1), points_.getZ(l - 1));

        dist = vec3n.distanceTo(vec3e);
        size = dist * alpha_ | 0;

        for (i = 0; i < size; i++) {

              vec3n.set(vec3s.x, vec3s.y, vec3s.z);
              vec3n.lerp(vec3e, i / size);
              positions.push(vec3n.x, vec3n.y, vec3n.z);

        }
      
  }
  return positions;
    
}

function generatePoints(line_, kof_) {

    var positions = [];
    var colors = [];
    var result = {

        positions,
        colors 

    };

    if (!line_) { return result; }

    var vec3s, vec3e, vec3n, size, s, dist;

    var pos = getPositions(line_.lPos, line_.drawRange.count, kof_);
    positions.push.apply(positions, pos);
    
    return result;   
}
function lerpFloat(v0_, v1_, t_) { return v0_ + (v1_ - v0_) * t_; }